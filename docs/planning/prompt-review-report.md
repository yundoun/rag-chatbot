# RAG 챗봇 프롬프트 설계 검토 보고서

**프로젝트명:** 사내 문서 검색용 RAG 챗봇
**작성일:** 2025-12-11
**작성자:** Requirement Analyst Agent
**문서 버전:** 1.0

---

## 1. 개요

### 1.1 검토 범위
- 8개 LLM 프롬프트의 완성도, 일관성, 구현 가능성 검토
- 5개 시나리오별 커버리지 분석
- 프롬프트 관리 전략 평가

### 1.2 검토 기준
- 프롬프트 완성도 및 명확성
- 출력 스키마 일관성
- 시나리오별 커버리지
- 예외 처리 충분성
- 구현 시 주의사항
- 개선 제안

---

## 2. 프롬프트별 상세 검토

### 2.1 프롬프트 #1: 질문 분석 (Query Processor)

| 항목 | 평가 |
|------|------|
| **목적** | 질문의 명확성, 복잡도, 모호성 분석 및 메타데이터 추출 |
| **호출 빈도** | 매 질문 1회 |
| **출력 형식** | JSON |
| **완성도** | ★★★★☆ |

#### 출력 스키마 분석
```json
{
  "refined_query": "string - 정제된 질문",
  "complexity": "simple | complex",
  "clarity_confidence": "0.0 ~ 1.0",
  "is_ambiguous": "boolean",
  "ambiguity_type": "multiple_interpretation | missing_context | vague_term | null",
  "detected_domains": ["string[]"]
}
```

#### 강점
- 출력 필드가 명확하게 정의됨
- `ambiguity_type`의 enum 값이 구체적
- `clarity_confidence` 수치화로 임계값 기반 분기 가능

#### 개선 권장
- [ ] `detected_domains` 가능한 값 목록 정의 필요
- [ ] `complexity` 판단 기준(예: 하위 질문 필요 여부) 명시 권장
- [ ] Few-shot 예시 추가로 일관성 향상 권장

---

### 2.2 프롬프트 #2: 명확화 질문 생성 (HITL Controller)

| 항목 | 평가 |
|------|------|
| **목적** | 모호한 질문에 대한 명확화 질문과 선택지 생성 |
| **호출 빈도** | 조건부 (모호한 질문만) |
| **출력 형식** | JSON |
| **완성도** | ★★★★☆ |

#### 출력 스키마 분석
```json
{
  "clarification_question": "string - 사용자에게 보여줄 질문",
  "options": ["string[] - 선택 가능한 옵션들"]
}
```

#### 강점
- 간결하고 목적에 맞는 출력 구조
- 옵션 제공으로 사용자 응답 유도

#### 개선 권장
- [ ] 옵션 개수 제한 명시 (예: 3-5개)
- [ ] "기타" 옵션 자동 포함 여부 결정
- [ ] `ambiguity_type`별 질문 생성 가이드라인 추가

---

### 2.3 프롬프트 #3: 질문 분해 (Agentic Controller)

| 항목 | 평가 |
|------|------|
| **목적** | 복잡한 질문을 검색 가능한 하위 질문으로 분해 |
| **호출 빈도** | 복잡한 질문만 |
| **출력 형식** | JSON |
| **완성도** | ★★★★★ |

#### 출력 스키마 분석
```json
{
  "original_intent": "string - 원래 질문의 의도 요약",
  "sub_questions": ["string[] - 분해된 하위 질문들"],
  "parallel_groups": [["int[]"] - 병렬 실행 가능한 질문 그룹"],
  "synthesis_guide": "string - 하위 답변 통합 가이드"
}
```

#### 강점
- `parallel_groups`로 병렬 처리 최적화 가능
- `synthesis_guide`로 답변 통합 품질 향상
- 매우 잘 설계된 스키마

#### 개선 권장
- [ ] 하위 질문 최대 개수 제한 명시 (토큰 관리)
- [ ] 분해 불필요 시 처리 방안 (원본 질문 반환)

---

### 2.4 프롬프트 #4: 관련성 평가 (Corrective RAG)

| 항목 | 평가 |
|------|------|
| **목적** | 검색된 문서의 질문 관련성 평가 |
| **호출 빈도** | 문서당 1회 |
| **출력 형식** | JSON |
| **완성도** | ★★★★☆ |

#### 출력 스키마 분석
```json
{
  "relevance_score": "0.0 ~ 1.0",
  "relevance_level": "high | medium | low",
  "reason": "string - 평가 근거",
  "useful_parts": ["string[] - 유용한 부분 인용"]
}
```

#### 강점
- 점수와 레벨 이중 평가로 유연성 확보
- `useful_parts`로 답변 생성 시 참조 용이
- `reason`으로 평가 투명성 확보

#### 개선 권장
- [ ] `relevance_level`과 `relevance_score` 매핑 명시 (high: 0.8+, medium: 0.5-0.8, low: <0.5)
- [ ] 배치 처리 옵션 검토 (비용 절감)
- [ ] 임베딩 유사도와의 가중 평균 계산 방식 명시

#### ⚠️ 주의사항
- **비용 이슈:** 문서당 1회 호출은 검색 결과가 많을 경우 비용 증가
- **권장:** Top-K 제한 또는 임베딩 유사도 사전 필터링 후 LLM 평가

---

### 2.5 프롬프트 #5: 쿼리 재작성 (Corrective RAG)

| 항목 | 평가 |
|------|------|
| **목적** | 검색 결과 부족 시 더 효과적인 쿼리로 재작성 |
| **호출 빈도** | 재시도 시 (최대 2회) |
| **출력 형식** | JSON |
| **완성도** | ★★★★★ |

#### 출력 스키마 분석
```json
{
  "strategy": "synonym_expansion | context_addition | generalization | specification",
  "rewritten_query": "string - 재작성된 쿼리",
  "changes_made": "string - 변경 내용 설명",
  "expected_improvement": "string - 예상되는 개선점"
}
```

#### 강점
- `strategy` enum으로 재작성 방법 명시화
- `changes_made`와 `expected_improvement`로 디버깅 용이
- 매우 잘 설계된 스키마

#### 개선 권장
- [ ] 이전 쿼리들을 컨텍스트로 제공하여 중복 방지
- [ ] 2차 재시도 시 다른 전략 선택 유도

---

### 2.6 프롬프트 #6: 답변 생성 (Response Generator)

| 항목 | 평가 |
|------|------|
| **목적** | 검색 문서 기반 최종 답변 생성 |
| **호출 빈도** | 매 질문 1회 |
| **출력 형식** | Free text (구조화된 답변) |
| **완성도** | ★★★☆☆ |

#### 출력 스키마 분석
```
response: Free text - 구조화된 답변
sources: 출처 인용
```

#### 강점
- 자유 형식 답변으로 자연스러운 응답 가능

#### ⚠️ 개선 필요
- [ ] **출력 구조 명확화 필요**
  - 답변과 출처 분리 방식 명시
  - 마크다운 포맷 가이드라인 제공
- [ ] **출처 인용 형식 정의**
  ```
  [1] 문서명, 섹션 (유사도: 0.85)
  ```
- [ ] **답변 길이 가이드라인** (토큰 제한)
- [ ] **할루시네이션 방지 지침** 명시
  - "검색된 문서에 없는 정보는 생성하지 마세요"

---

### 2.7 프롬프트 #7: 답변 품질 평가 (Response Generator)

| 항목 | 평가 |
|------|------|
| **목적** | 생성된 답변의 완전성, 정확성, 명확성 평가 |
| **호출 빈도** | 매 답변 1회 |
| **출력 형식** | JSON |
| **완성도** | ★★★★☆ |

#### 출력 스키마 분석
```json
{
  "completeness": "0.0 ~ 1.0 - 질문에 대한 답변 완전성",
  "accuracy": "0.0 ~ 1.0 - 출처 기반 정확성",
  "clarity": "0.0 ~ 1.0 - 답변 명확성",
  "confidence": "0.0 ~ 1.0 - 종합 신뢰도",
  "needs_disclaimer": "boolean - 면책 조항 필요 여부"
}
```

#### 강점
- 다차원 품질 평가로 세밀한 판단 가능
- `needs_disclaimer`로 불확실한 답변 사용자 고지

#### 개선 권장
- [ ] 각 점수의 가중 평균 → `confidence` 계산식 명시
- [ ] `needs_disclaimer` 트리거 조건 명시 (예: confidence < 0.6)
- [ ] 품질 미달 시 HITL 연계 로직 정의

---

### 2.8 프롬프트 #8: 웹 검색 결과 통합 (Web Search Agent)

| 항목 | 평가 |
|------|------|
| **목적** | 웹 검색 결과 정제 및 신뢰도 평가 |
| **호출 빈도** | 웹 검색 시 (Fallback) |
| **출력 형식** | JSON |
| **완성도** | ★★★★☆ |

#### 출력 스키마 분석
```json
{
  "relevant_results": [{
    "title": "string",
    "url": "string",
    "summary": "string",
    "relevance": "0.0 ~ 1.0"
  }],
  "overall_confidence": "0.0 ~ 1.0",
  "integration_notes": "string - 통합 시 주의사항",
  "disclaimer_needed": "boolean"
}
```

#### 강점
- 결과별 관련성 점수로 필터링 가능
- `integration_notes`로 답변 생성 가이드
- 외부 정보 사용 시 면책 조항 처리

#### 개선 권장
- [ ] 웹 결과 최대 개수 제한
- [ ] 날짜 정보 포함 (최신성 판단)
- [ ] 신뢰할 수 있는 도메인 목록 정의

---

## 3. 시나리오별 커버리지 분석

### 3.1 시나리오 매핑

| 시나리오 | 관련 프롬프트 | 커버리지 |
|----------|-------------|----------|
| **Happy Path** | #1 → #4 → #6 → #7 | ✅ 완전 |
| **HITL 개입** | #1 → #2 → #1 → #4 → #6 → #7 | ✅ 완전 |
| **Corrective Flow** | #1 → #4 → #5 → #4 → #6 → #7 | ✅ 완전 |
| **Web Fallback** | #1 → #4 → #5 → #4 → #8 → #6 → #7 | ✅ 완전 |
| **Complex Query** | #1 → #3 → [#4]×N → #6 → #7 | ✅ 완전 |

### 3.2 시나리오 플로우 다이어그램

```
┌─────────────────────────────────────────────────────────────────────┐
│                        사용자 질문 입력                              │
└─────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│              프롬프트 #1: 질문 분석 (Query Processor)                │
│         complexity, clarity_confidence, is_ambiguous 판단           │
└─────────────────────────────────────────────────────────────────────┘
                                  │
                    ┌─────────────┼─────────────┐
                    ▼             ▼             ▼
            is_ambiguous?    complexity?    clarity OK
                    │             │             │
                    ▼             ▼             │
         ┌──────────────┐ ┌──────────────┐     │
         │ 프롬프트 #2  │ │ 프롬프트 #3  │     │
         │ 명확화 질문  │ │ 질문 분해    │     │
         └──────────────┘ └──────────────┘     │
                    │             │             │
                    └─────────────┴─────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│              프롬프트 #4: 관련성 평가 (Corrective RAG)               │
│                    relevance_score 계산                              │
└─────────────────────────────────────────────────────────────────────┘
                                  │
                    ┌─────────────┴─────────────┐
                    ▼                           ▼
           충분한 관련 문서?              문서 부족?
            (≥0.8, ≥2개)                    │
                    │                       ▼
                    │             ┌──────────────────┐
                    │             │ 프롬프트 #5:      │
                    │             │ 쿼리 재작성       │
                    │             │ (최대 2회)        │
                    │             └──────────────────┘
                    │                       │
                    │                       ▼
                    │              재검색 성공?
                    │             ┌────┴────┐
                    │             ▼         ▼
                    │           성공      실패
                    │             │         │
                    │             │         ▼
                    │             │  ┌──────────────┐
                    │             │  │ 프롬프트 #8: │
                    │             │  │ 웹 검색 통합 │
                    │             │  └──────────────┘
                    │             │         │
                    └─────────────┴─────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│              프롬프트 #6: 답변 생성 (Response Generator)             │
└─────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│              프롬프트 #7: 답변 품질 평가                             │
│                    confidence, needs_disclaimer                      │
└─────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
                           최종 답변 출력
```

---

## 4. 출력 스키마 일관성 분석

### 4.1 일관성 평가

| 측면 | 상태 | 비고 |
|------|------|------|
| JSON 형식 통일 | ✅ | 7/8 프롬프트 JSON (답변 생성만 Free text) |
| 점수 범위 통일 | ✅ | 모든 점수 0.0~1.0 |
| Boolean 네이밍 | ✅ | `is_`, `needs_` 접두사 일관 |
| 배열 처리 | ⚠️ | 빈 배열 처리 방식 미정의 |

### 4.2 개선 권장: 공통 타입 정의

```typescript
// 공통 점수 타입
type Score = number; // 0.0 ~ 1.0

// 공통 Enum 타입들
type Complexity = "simple" | "complex";
type RelevanceLevel = "high" | "medium" | "low";
type AmbiguityType = "multiple_interpretation" | "missing_context" | "vague_term" | null;
type RewriteStrategy = "synonym_expansion" | "context_addition" | "generalization" | "specification";

// 공통 출력 래퍼
interface PromptOutput<T> {
  success: boolean;
  data: T;
  error?: string;
  processing_time_ms?: number;
}
```

---

## 5. 예외 처리 충분성 평가

### 5.1 식별된 예외 상황

| 예외 상황 | 현재 처리 | 권장 처리 |
|----------|----------|----------|
| LLM 응답 파싱 실패 | ❌ 미정의 | JSON 스키마 검증 + 재시도 |
| 빈 검색 결과 | ✅ Web Fallback | 충분 |
| 모든 문서 관련성 낮음 | ✅ 쿼리 재작성 | 충분 |
| HITL 무한 루프 | ✅ 최대 2회 | 충분 |
| 쿼리 재작성 실패 | ✅ Web Fallback | 충분 |
| 웹 검색도 실패 | ⚠️ 미정의 | "답변 불가" 응답 정의 필요 |
| 질문 분해 과다 | ⚠️ 미정의 | 최대 하위 질문 수 제한 |
| API Rate Limit | ❌ 미정의 | 재시도 로직 + 백오프 |
| 토큰 한도 초과 | ❌ 미정의 | 문서 청킹/요약 로직 |

### 5.2 권장: 에러 응답 스키마

```json
{
  "error_type": "parsing_error | api_error | no_result | token_limit",
  "error_message": "string",
  "recoverable": "boolean",
  "fallback_action": "retry | web_search | ask_user | return_partial"
}
```

---

## 6. 성능 및 비용 분석

### 6.1 시나리오별 LLM 호출 횟수

| 시나리오 | 호출 횟수 | 예상 시간 |
|----------|----------|----------|
| Happy Path | 4회 (#1, #4×N, #6, #7) | 8-9초 |
| HITL 개입 | 5회 | 10초 + 사용자 응답 |
| Corrective Flow | 6-8회 | 10-12초 |
| Web Fallback | 7-9회 | 12-14초 |
| Complex Query | 4 + 3×M회 (M=하위질문수) | 13-15초 |

### 6.2 비용 최적화 권장

1. **관련성 평가 배치 처리**
   - 현재: 문서당 개별 호출
   - 권장: 최대 5개 문서 배치 평가

2. **캐싱 전략**
   - 동일 질문 캐싱 (TTL: 1시간)
   - 관련성 평가 결과 캐싱

3. **모델 계층화**
   - 질문 분석: GPT-3.5 (비용 절감)
   - 답변 생성: GPT-4o (품질 유지)

---

## 7. 종합 평가

### 7.1 프롬프트별 완성도 점수

| 프롬프트 | 완성도 | 주요 이슈 |
|----------|--------|----------|
| #1 질문 분석 | ★★★★☆ | domains 목록 미정의 |
| #2 명확화 질문 | ★★★★☆ | 옵션 개수 미정의 |
| #3 질문 분해 | ★★★★★ | 우수 |
| #4 관련성 평가 | ★★★★☆ | 비용 이슈 |
| #5 쿼리 재작성 | ★★★★★ | 우수 |
| #6 답변 생성 | ★★★☆☆ | 출력 구조 미흡 |
| #7 품질 평가 | ★★★★☆ | 계산식 미정의 |
| #8 웹 검색 통합 | ★★★★☆ | 날짜 정보 누락 |

### 7.2 종합 점수

| 항목 | 점수 |
|------|------|
| 프롬프트 완성도 | 8.2/10 |
| 출력 스키마 일관성 | 8.5/10 |
| 시나리오 커버리지 | 9.5/10 |
| 예외 처리 충분성 | 7.0/10 |
| **종합** | **8.3/10** |

### 7.3 최종 결론

**✅ 구현 가능 - 소폭 개선 권장**

프롬프트 설계가 전반적으로 잘 되어 있으며, 시나리오 커버리지가 완전합니다.

#### 우선 개선 사항 (구현 전)
1. **프롬프트 #6 (답변 생성):** 출력 구조 명확화, 할루시네이션 방지 지침 추가
2. **예외 처리:** 웹 검색 실패 시 응답, API 에러 처리 로직 정의
3. **공통 타입:** Enum 값들의 명확한 정의

#### 구현 후 개선 사항
1. 관련성 평가 배치 처리로 비용 최적화
2. 프롬프트 버전별 A/B 테스트 파이프라인
3. 골든 데이터셋 기반 프롬프트 품질 모니터링

---

## 8. 체크리스트

### 구현 전 필수 작업
- [ ] 프롬프트 #6 출력 형식 정의
- [ ] `detected_domains` 가능한 값 목록 작성
- [ ] 각 점수별 임계값 문서화
- [ ] 에러 처리 전략 문서화

### 구현 시 확인 사항
- [ ] 모든 프롬프트에 Few-shot 예시 추가
- [ ] JSON 스키마 검증 로직 구현
- [ ] 재시도 로직 (파싱 실패, API 에러)
- [ ] 토큰 사용량 모니터링

---

**보고서 작성 완료**

*본 보고서는 제공된 프롬프트 설계 문서를 기반으로 작성되었습니다.*
