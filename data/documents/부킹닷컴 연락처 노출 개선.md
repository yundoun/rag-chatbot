# 기획서

https://www.figma.com/design/kYgkiTpk67AGSKdSTdjaOO/%EC%83%81%EB%B0%98%EA%B8%B0%EC%84%9C%EB%B9%84%EC%8A%A4?node-id=3448-1603&t=ymIS9kQwmvdPbsgF-1

---

# 기획 배경

## 문제 상황

PMS(Property Management System)에는 예약자 상세 정보에 휴대폰 번호 및 안심번호를 노출하는 부분이 있습니다. 현재 시스템은 서버에서 `01099991111` 형식으로 번호를 전달받으면, 안심번호 여부에 따라 다음과 같이 처리합니다:

- **안심번호인 경우**: 마스킹 처리 (예: `010-****-1111`)
- **일반번호인 경우**: 포맷팅 적용 (예: `010-9999-1111`)

그러나 부킹닷컴(Booking.com)을 통해 해외에서 예약된 건들은 국제전화번호 형식으로 전달되어 텍스트 포맷팅이 잘못 노출되는 오류가 발생하였습니다.

## 해외 번호 예시

| 국가 | 원본 번호 | 현재 잘못된 노출 |
|------|-----------|------------------|
| 네덜란드 | +31 6 16478294 | 031-6164-7829 |
| 미국 | +1 442 320 3248 | 014-4232-0324 |
| 영국 | +44 7911 123456 | 044-7911-1234 |
| 일본 | +81 90 1234 5678 | 081-9012-3456 |
| 중국 | +86 138 0013 8000 | 086-1380-0138 |

## 개선 목표

국제번호 규격(`+`로 시작하는 번호)일 경우 텍스트 포맷팅 없이 서버에서 전달받은 값 그대로 노출하도록 개선합니다.

---

# 기획 설명

## 판단 로직

```
번호가 '+'로 시작하는가?
├── YES → 포맷팅 없이 원본 그대로 노출
└── NO → 기존 로직 유지 (안심번호 여부에 따라 마스킹/포맷팅)
```

## 상세 처리 규칙

### 1. 국제번호 판별 조건
- 번호 문자열이 `+`로 시작하는 경우 국제번호로 판단
- 공백, 하이픈 등 구분자 포함 여부와 관계없이 `+` 시작 여부만 체크

### 2. 노출 방식
| 번호 유형 | 판별 조건 | 노출 방식 | 예시 |
|-----------|-----------|-----------|------|
| 국제번호 | `+`로 시작 | 원본 그대로 | `+31 6 16478294` |
| 국내 안심번호 | 안심번호 플래그 true | 마스킹 처리 | `010-****-1111` |
| 국내 일반번호 | 안심번호 플래그 false | 하이픈 포맷팅 | `010-9999-1111` |

### 3. 전화 연결 기능
- 국제번호의 경우에도 `tel:` 링크는 정상 동작해야 함
- 클릭 시 `tel:+31616478294` 형태로 호출 (공백 제거)

---

# 작업 범위

- **서비스**: PMS (모텔, 호텔, 펜션) PC, Mobile
- **영향 채널**: 부킹닷컴 예약 건 (Booking.com OTA 연동)

## PMS PC

### 1. GNB 메뉴
1. 예약내역
2. 정산관리 > 정산내역

### 2. 수정 영역 상세

#### 2.1 예약내역

**경로**: 예약내역 > 목록 > 상세정보 팝업

**현재 화면 구성**:
```
┌─────────────────────────────────────────────────────────┐
│  예약 상세 정보                                    [X]  │
├─────────────────────────────────────────────────────────┤
│  예약번호: BK-2025031234                                │
│  예약채널: Booking.com                                  │
│  예약일시: 2025-03-15 14:32:21                          │
├─────────────────────────────────────────────────────────┤
│  예약자 정보                                            │
│  ─────────────────────────────────────────────────────  │
│  예약자명: John Smith                                   │
│  휴대폰: 031-6164-7829  ← [수정 필요: 잘못된 포맷팅]   │
│  이메일: john.smith@email.com                           │
├─────────────────────────────────────────────────────────┤
│  투숙 정보                                              │
│  ─────────────────────────────────────────────────────  │
│  체크인: 2025-03-20                                     │
│  체크아웃: 2025-03-22                                   │
│  객실: 디럭스 더블 (201호)                              │
│  인원: 성인 2명                                         │
└─────────────────────────────────────────────────────────┘
```

**개선 후 화면**:
```
│  휴대폰: +31 6 16478294  ← [개선: 원본 그대로 노출]    │
```

**관련 컴포넌트**: `ReservationDetailModal.tsx`

**수정 대상 필드**:
- `guestPhone` (예약자 휴대폰)
- `guestSafeNumber` (안심번호)

---

#### 2.2 정산관리 > 정산내역

**경로**: 정산관리 > 정산내역 > 목록 > 상세정보 팝업

**현재 화면 구성**:
```
┌─────────────────────────────────────────────────────────┐
│  정산 상세 정보                                    [X]  │
├─────────────────────────────────────────────────────────┤
│  정산번호: SET-202503-0042                              │
│  정산상태: 정산완료                                     │
│  정산일: 2025-03-25                                     │
├─────────────────────────────────────────────────────────┤
│  예약 정보                                              │
│  ─────────────────────────────────────────────────────  │
│  예약번호: BK-2025031234                                │
│  예약채널: Booking.com                                  │
│  예약자명: Emma Wilson                                  │
│  휴대폰: 014-4232-0324  ← [수정 필요: 잘못된 포맷팅]   │
├─────────────────────────────────────────────────────────┤
│  정산 금액                                              │
│  ─────────────────────────────────────────────────────  │
│  객실료: ₩150,000                                       │
│  수수료: ₩22,500 (15%)                                  │
│  정산액: ₩127,500                                       │
└─────────────────────────────────────────────────────────┘
```

**개선 후 화면**:
```
│  휴대폰: +1 442 320 3248  ← [개선: 원본 그대로 노출]   │
```

**관련 컴포넌트**: `SettlementDetailModal.tsx`

---

## PMS Mobile

### 1. GNB 메뉴
1. 예약내역

### 2. 수정 영역 상세

#### 2.1 예약내역 > 상세 예약내역

**경로**: 예약내역 > 예약 카드 탭 > 상세 예약내역 화면

**현재 화면 구성 (Mobile)**:
```
┌───────────────────────────┐
│  ← 예약 상세              │
├───────────────────────────┤
│  ┌─────────────────────┐  │
│  │ Booking.com         │  │
│  │ BK-2025031234       │  │
│  └─────────────────────┘  │
│                           │
│  예약자 정보              │
│  ───────────────────────  │
│  이름: Hans Müller        │
│  연락처: 049-1512-3456    │
│       ↑ [수정 필요]       │
│  이메일: hans@email.de    │
│                           │
│  투숙 정보                │
│  ───────────────────────  │
│  체크인: 2025-03-18       │
│  체크아웃: 2025-03-20     │
│  객실: 스탠다드 트윈      │
│                           │
│  [전화하기]  [문자보내기] │
└───────────────────────────┘
```

**개선 후 화면**:
```
│  연락처: +49 151 23456789 │
│       ↑ [개선 완료]       │
```

**관련 컴포넌트**: `MobileReservationDetail.tsx`

---

# 기술 명세

## 영향받는 파일 목록

### PC PMS
| 파일 경로 | 설명 |
|-----------|------|
| `src/components/reservation/ReservationDetailModal.tsx` | 예약 상세 모달 |
| `src/components/settlement/SettlementDetailModal.tsx` | 정산 상세 모달 |
| `src/utils/phoneFormatter.ts` | 전화번호 포맷팅 유틸 |
| `src/hooks/usePhoneDisplay.ts` | 전화번호 노출 훅 |

### Mobile PMS
| 파일 경로 | 설명 |
|-----------|------|
| `src/mobile/pages/ReservationDetail.tsx` | 예약 상세 페이지 |
| `src/mobile/components/GuestInfoCard.tsx` | 예약자 정보 카드 |

## 수정 코드 예시

### phoneFormatter.ts (수정 전)
```typescript
export const formatPhoneNumber = (phone: string, isSafeNumber: boolean): string => {
  if (!phone) return '-';
  
  const cleaned = phone.replace(/\D/g, '');
  
  if (isSafeNumber) {
    // 안심번호 마스킹
    return cleaned.replace(/(\d{3})(\d{4})(\d{4})/, '$1-****-$3');
  }
  
  // 일반 포맷팅
  return cleaned.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
};
```

### phoneFormatter.ts (수정 후)
```typescript
export const formatPhoneNumber = (phone: string, isSafeNumber: boolean): string => {
  if (!phone) return '-';
  
  // 국제번호 체크: +로 시작하면 원본 그대로 반환
  if (phone.startsWith('+')) {
    return phone;
  }
  
  const cleaned = phone.replace(/\D/g, '');
  
  if (isSafeNumber) {
    // 안심번호 마스킹
    return cleaned.replace(/(\d{3})(\d{4})(\d{4})/, '$1-****-$3');
  }
  
  // 일반 포맷팅
  return cleaned.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
};

// 전화 연결용 번호 생성 (공백 제거)
export const getCallableNumber = (phone: string): string => {
  if (!phone) return '';
  
  if (phone.startsWith('+')) {
    // 국제번호: 공백만 제거
    return phone.replace(/\s/g, '');
  }
  
  // 국내번호: 숫자만 추출
  return phone.replace(/\D/g, '');
};
```

## 테스트 케이스

### 단위 테스트
```typescript
describe('formatPhoneNumber', () => {
  // 국제번호 테스트
  it('네덜란드 번호를 원본 그대로 반환한다', () => {
    expect(formatPhoneNumber('+31 6 16478294', false)).toBe('+31 6 16478294');
  });
  
  it('미국 번호를 원본 그대로 반환한다', () => {
    expect(formatPhoneNumber('+1 442 320 3248', false)).toBe('+1 442 320 3248');
  });
  
  it('영국 번호를 원본 그대로 반환한다', () => {
    expect(formatPhoneNumber('+44 7911 123456', false)).toBe('+44 7911 123456');
  });
  
  it('일본 번호를 원본 그대로 반환한다', () => {
    expect(formatPhoneNumber('+81 90 1234 5678', false)).toBe('+81 90 1234 5678');
  });
  
  // 국내번호 테스트
  it('국내 일반번호를 포맷팅한다', () => {
    expect(formatPhoneNumber('01099991111', false)).toBe('010-9999-1111');
  });
  
  it('국내 안심번호를 마스킹한다', () => {
    expect(formatPhoneNumber('01099991111', true)).toBe('010-****-1111');
  });
  
  // 엣지 케이스
  it('빈 문자열은 -를 반환한다', () => {
    expect(formatPhoneNumber('', false)).toBe('-');
  });
  
  it('null은 -를 반환한다', () => {
    expect(formatPhoneNumber(null as any, false)).toBe('-');
  });
});

describe('getCallableNumber', () => {
  it('국제번호의 공백을 제거한다', () => {
    expect(getCallableNumber('+31 6 16478294')).toBe('+31616478294');
  });
  
  it('국내번호의 숫자만 추출한다', () => {
    expect(getCallableNumber('010-9999-1111')).toBe('01099991111');
  });
});
```

### E2E 테스트 시나리오

| 시나리오 | 테스트 단계 | 예상 결과 |
|----------|-------------|-----------|
| 국제번호 예약 조회 | 1. 개발기 웹테스트모텔 접속<br>2. 예약내역 메뉴 진입<br>3. 2025년 3월 조회<br>4. 부킹닷컴 예약 건 상세 확인 | 휴대폰 번호가 `+31 6 16478294` 형태로 노출 |
| 국제번호 전화 연결 | 1. 상세 팝업에서 전화번호 클릭 | `tel:+31616478294`로 전화 앱 연결 |
| 국내번호 기존 동작 | 1. 국내 예약 건 상세 확인 | 기존과 동일하게 `010-9999-1111` 포맷 유지 |
| 안심번호 마스킹 | 1. 안심번호 설정된 예약 건 확인 | `010-****-1111` 마스킹 유지 |

---

# 이슈 트래킹

## 지라 이슈

| 구분 | 이슈 키 | 제목 | 담당자 | 상태 |
|------|---------|------|--------|------|
| 프론트엔드 | [FRONT24-265](https://coolstay.atlassian.net/browse/FRONT24-265) | [PMS] 부킹닷컴 국제번호 포맷팅 개선 | 김도운 | In Progress |
| QA | [VGQA-2295](https://coolstay.atlassian.net/browse/VGQA-2295) | [PMS] 부킹닷컴 휴대폰 번호 부분만 노출되는 문제 | 박지영 | Ready for QA |
| 백엔드 | BACK24-189 | [API] 국제번호 원본 전달 확인 | 이상현 | Done |

## 타임라인

| 일자 | 마일스톤 |
|------|----------|
| 2025-05-12 | 기획 확정 |
| 2025-05-14 | 개발 착수 |
| 2025-05-16 | 개발 완료 및 코드 리뷰 |
| 2025-05-19 | QA 테스트 |
| 2025-05-21 | 상용 배포 |

---

# QA 체크리스트

## PC PMS

- [ ] 예약내역 > 부킹닷컴 예약 건 상세에서 국제번호 원본 노출 확인
- [ ] 정산내역 > 부킹닷컴 예약 건 상세에서 국제번호 원본 노출 확인
- [ ] 국내번호 예약 건 기존 포맷팅 유지 확인
- [ ] 안심번호 마스킹 기존 동작 유지 확인
- [ ] 전화번호 클릭 시 전화 연결 정상 동작 확인

## Mobile PMS

- [ ] 예약 상세에서 국제번호 원본 노출 확인
- [ ] 전화하기 버튼 클릭 시 국제번호 정상 연결 확인
- [ ] 문자보내기 버튼 클릭 시 국제번호 정상 동작 확인
- [ ] 국내번호 기존 동작 유지 확인

## 크로스 브라우저

- [ ] Chrome (최신)
- [ ] Safari (최신)
- [ ] Edge (최신)
- [ ] Mobile Safari (iOS 15+)
- [ ] Mobile Chrome (Android 12+)

---

# 특이사항

## 테스트 데이터 확인 방법

개발기 웹테스트모텔의 2025년 3월 데이터를 조회하시면 부킹닷컴 국제번호 예약 건을 확인할 수 있습니다.

**테스트 예약 건 예시**:
| 예약번호 | 예약자명 | 국가 | 전화번호 |
|----------|----------|------|----------|
| BK-2025030001 | John Smith | 네덜란드 | +31 6 16478294 |
| BK-2025030002 | Emma Wilson | 미국 | +1 442 320 3248 |
| BK-2025030003 | Hans Müller | 독일 | +49 151 23456789 |
| BK-2025030004 | Yuki Tanaka | 일본 | +81 90 1234 5678 |
| BK-2025030005 | Wei Chen | 중국 | +86 138 0013 8000 |

## 배포 정보

- **상용 배포 예정일**: 2025-05-21 (수)
- **배포 시간**: 02:00 ~ 04:00 (새벽 점검 시간)
- **롤백 계획**: 기존 버전 Docker 이미지로 즉시 롤백 가능

## 관련 문서

- [PMS 전화번호 처리 가이드](https://wiki.coolstay.co.kr/pms/phone-handling)
- [부킹닷컴 OTA 연동 명세서](https://wiki.coolstay.co.kr/ota/booking-integration)
- [안심번호 서비스 정책](https://wiki.coolstay.co.kr/service/safe-number-policy)

---

# 변경 이력

| 버전 | 일자 | 작성자 | 변경 내용 |
|------|------|--------|-----------|
| 1.0 | 2025-05-12 | 김민서 (기획) | 최초 작성 |
| 1.1 | 2025-05-14 | 김도운 (개발) | 기술 명세 추가 |
| 1.2 | 2025-05-16 | 박지영 (QA) | QA 체크리스트 추가 |